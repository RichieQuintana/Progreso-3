<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IntegraHub - Demo Portal</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 25px; }
        h1 { color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; color: #555; }
        .status-up { color: #28a745; font-weight: bold; }
        .status-down { color: #dc3545; font-weight: bold; }
        button { background-color: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s; margin-right: 5px; }
        button:hover { background-color: #1557b0; }
        .btn-error { background-color: #dc3545; }
        .btn-error:hover { background-color: #a71d2a; }
        .btn-random { background-color: #6c757d; }
        .btn-random:hover { background-color: #5a6268; }
        code { background: #eee; padding: 2px 4px; border-radius: 4px; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>üöÄ IntegraHub Demo Portal</h1>
    
    <div class="card">
        <h3>Estado del Ecosistema</h3>
        <div id="status">Cargando salud del sistema...</div>
    </div>

    <div class="card">
        <h3>Operaciones de Pedidos</h3>
        <button onclick="crearPedido(50)">Pedido Fijo ($50)</button>
        <button class="btn-random" onclick="crearPedidoAleatorio(true)">Pedido Azar (V√°lido)</button>
        <button class="btn-error" onclick="crearPedidoAleatorio(false)">Pedido Azar (Negativo -> DLQ)</button>
    </div>

    <div class="card">
        <h3>Trazabilidad de Pedidos (Correlation-ID / Order-ID)</h3>
        <table>
            <thead>
                <tr>
                    <th>Correlation-ID</th>
                    <th>Cliente</th>
                    <th>Monto</th>
                    <th>Estado Actual</th>
                </tr>
            </thead>
            <tbody id="orders-table">
                <tr><td colspan="4" style="text-align:center">No hay pedidos registrados</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const API_URL = 'http://localhost:9000';

        // 1. Cargar Salud del Sistema
        async function loadStatus() {
            try {
                const r = await fetch(`${API_URL}/health`);
                const data = await r.json();
                document.getElementById('status').innerHTML = 
                    `<span class="status-up">‚óè SYSTEM ONLINE</span> (Base de Datos: ${data.database}, Mensajer√≠a: ${data.broker})`;
            } catch (e) {
                document.getElementById('status').innerHTML = `<span class="status-down">‚óè SYSTEM OFFLINE</span> (No se pudo conectar con la API)`;
            }
        }

        // 2. Listar Pedidos para Trazabilidad
        async function loadOrders() {
            try {
                const res = await fetch(`${API_URL}/orders`);
                const list = await res.json();
                const tbody = document.getElementById('orders-table');
                
                if (list.length === 0) return;

                tbody.innerHTML = list.map(o => `
                    <tr>
                        <td><code>${o.id}</code></td>
                        <td>${o.customer_name}</td>
                        <td>$${parseFloat(o.total_amount).toFixed(2)}</td>
                        <td><strong>${o.status}</strong></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.warn('Error al listar pedidos:', e.message);
            }
        }

        // 3. L√≥gica para Pedidos Aleatorios
        function crearPedidoAleatorio(esValido) {
            const clientes = ["Matias Romo", "Ariel Ramos", "Pancho", "Richie Quintana", "Demo User"];
            const cliente = clientes[Math.floor(Math.random() * clientes.length)];
            const montoBase = (Math.random() * 100 + 1).toFixed(2);
            const montoFinal = esValido ? montoBase : (montoBase * -1).toFixed(2);
            
            crearPedido(montoFinal, cliente);
        }

        // 4. Crear Pedido (Seguridad JWT + Pub/Sub)
        async function crearPedido(monto, cliente = "Cliente Demo Portal") {
            try {
                // Obtener Token JWT
                const tokenRes = await fetch(`${API_URL}/login-demo`);
                const { token } = await tokenRes.json();

                const id = crypto.randomUUID(); // Correlation-ID para Trazabilidad
                const body = { id, customer_name: cliente, total_amount: Number(monto) };

                const res = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    console.log(`Pedido ${id} enviado.`);
                    await loadOrders();
                } else {
                    const err = await res.json();
                    alert('Error: ' + (err.error || 'Fallo en validaci√≥n'));
                }
            } catch (e) {
                alert('Error de conexi√≥n con la API');
            }
        }

        loadStatus();
        loadOrders();
        setInterval(loadOrders, 5000); // Refresco cada 5 segundos
        setInterval(loadStatus, 10000); // Check de salud cada 10 segundos
    </script>
</body>
</html>