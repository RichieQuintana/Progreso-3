<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IntegraHub - Demo Portal</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 25px; }
        h1 { color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; color: #555; }
        .status-up { color: #28a745; font-weight: bold; }
        .status-down { color: #dc3545; font-weight: bold; }
        button { background-color: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        button:hover { background-color: #1557b0; }
        .btn-error { background-color: #dc3545; margin-left: 10px; }
        .btn-error:hover { background-color: #a71d2a; }
    </style>
</head>
<body>
    <h1>üöÄ IntegraHub Demo Portal</h1>
    
    <div class="card">
        <h3>Estado del Ecosistema</h3>
        <div id="status">Cargando salud del sistema...</div>
    </div>

    <div class="card">
        <h3>Operaciones de Pedidos</h3>
        <button onclick="crearPedido(50)">Generar Pedido Exitoso ($50)</button>
        <button class="btn-error" onclick="crearPedido(-50)">Generar Pedido Inv√°lido (-$50)</button>
    </div>

    <div class="card">
        <h3>Trazabilidad de Pedidos (Correlation-ID / Order-ID)</h3>
        <table>
            <thead>
                <tr>
                    <th>Correlation-ID</th>
                    <th>Cliente</th>
                    <th>Monto</th>
                    <th>Estado Actual</th>
                </tr>
            </thead>
            <tbody id="orders-table">
                <tr><td colspan="4" style="text-align:center">No hay pedidos registrados</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // CONFIGURACI√ìN: URL de la API en el puerto 9000
        const API_URL = 'http://localhost:9000';

        // 1. Cargar Salud del Sistema (Requisito 5.5)
        async function loadStatus() {
            try {
                const r = await fetch(`${API_URL}/health`);
                const data = await r.json();
                document.getElementById('status').innerHTML = 
                    `<span class="status-up">‚óè SYSTEM ONLINE</span> (Base de Datos: ${data.database}, Mensajer√≠a: ${data.broker})`;
            } catch (e) {
                document.getElementById('status').innerHTML = `<span class="status-down">‚óè SYSTEM OFFLINE</span> (No se pudo conectar con la API en ${API_URL})`;
            }
        }

        // 2. Listar Pedidos (Requisito 5.4)
        async function loadOrders() {
            try {
                const res = await fetch(`${API_URL}/orders`);
                const list = await res.json();
                const tbody = document.getElementById('orders-table');
                
                if (list.length === 0) return;

                tbody.innerHTML = list.map(o => `
                    <tr>
                        <td><code>${o.id}</code></td>
                        <td>${o.customer_name}</td>
                        <td>$${o.total_amount}</td>
                        <td><strong>${o.status}</strong></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.warn('Error al listar pedidos:', e.message);
            }
        }

        // 3. Crear Pedido (Flujo A + Seguridad JWT)
        async function crearPedido(monto) {
            try {
                // Requisito 4.3: Obtener token de seguridad
                const tokenRes = await fetch(`${API_URL}/login-demo`);
                if (!tokenRes.ok) throw new Error('Fallo en autenticaci√≥n demo');
                const { token } = await tokenRes.json();

                const id = crypto.randomUUID(); // Usado como Correlation-ID
                const body = { 
                    id, 
                    customer_name: "Cliente Demo Portal", 
                    total_amount: Number(monto) 
                };

                const res = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    alert(`Pedido ${id} enviado correctamente.`);
                    await loadOrders();
                } else {
                    const err = await res.json();
                    alert('Error: ' + (err.error || 'No autorizado'));
                }
            } catch (e) {
                alert('Error de conexi√≥n: ' + e.message);
            }
        }

        // Inicializaci√≥n autom√°tica al cargar la p√°gina
        loadStatus();
        loadOrders();
        // Refresco autom√°tico de la tabla cada 10 segundos
        setInterval(loadOrders, 10000);
    </script>
</body>
</html>